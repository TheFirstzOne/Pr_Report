<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR Expense Monitoring Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .loading-spinner { 
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container { position: relative; height: 300px; }
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
        }
        .status-received { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-other { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white p-6 shadow-lg">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-3xl font-bold mb-2">üìä PR Expense Monitoring Dashboard</h1>
                <p class="text-blue-100">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ Purchase Request 2025</p>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Expense Card -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                            <p id="totalExpense" class="text-2xl font-bold text-green-600">0 ‡∏ø</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Total Records Card -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="totalRecords" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- All PRs Card -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="allPRsCount" class="text-2xl font-bold text-red-600">0</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Active Months Card -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                            <p id="activeMonths" class="text-2xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Monthly Expense Chart -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üìà ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                    <div class="chart-container">
                        <canvas id="monthlyExpenseChart"></canvas>
                    </div>
                </div>

                <!-- Interactive PR Distribution Chart -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ PR</h3>
                        <div class="flex items-center space-x-2">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <select id="chartTypeSelector" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="month">‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="status">‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- All PRs Table -->
            <div class="bg-white rounded-xl shadow-md mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà PR No. ‡∏ã‡πâ‡∏≥)</h3>
                        <div class="flex items-center space-x-4">
                            <!-- Month Filter -->
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <select id="monthFilter" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                </select>
                            </div>
                            
                            <!-- Status Filter -->
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <select id="statusFilter" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PR No.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="allPRsTable" class="bg-white divide-y divide-gray-200">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Summary Table -->
            <div class="bg-white rounded-xl shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% ‡∏Ç‡∏≠‡∏á‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody id="monthlySummaryTable" class="bg-white divide-y divide-gray-200">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</h3>
                <div id="insights" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Insights will be populated by JavaScript -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-8">
            <div class="max-w-7xl mx-auto px-6 text-center">
                <p>&copy; 2025 PR Expense Monitoring Dashboard. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ Google Apps Script + Tailwind CSS</p>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let dashboardData = null;
        let monthlyChart = null;
        let distributionChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        // Load data from Google Apps Script
        function loadDashboardData() {
            google.script.run
                .withSuccessHandler(onDataLoaded)
                .withFailureHandler(onDataError)
                .getPRData();
        }

        // Handle successful data load
        function onDataLoaded(data) {
            console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
            
            if (data.error) {
                onDataError(data.error);
                return;
            }

            dashboardData = data;
            
            // Update summary cards
            updateSummaryCards(data);
            
            // Create charts
            createMonthlyExpenseChart(data.monthlySummary);
            createDistributionChart(data.allPRs, data.monthlySummary, 'month'); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            
            // Populate tables
            populateAllPRsTable(data.allPRs);
            populateMonthlySummaryTable(data.monthlySummary);
            
            // Create insights
            createInsights(data);
            
            // Setup filters
            setupMonthFilter(data.allPRs);
            setupStatusFilter(data.allPRs);
            
            // Setup chart type selector
            setupChartTypeSelector(data.allPRs, data.monthlySummary);
            
            // Hide loading screen and show content
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Handle data load error
        function onDataError(error) {
            console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
            document.getElementById('loadingScreen').innerHTML = `
                <div class="text-center">
                    <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-red-600 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                    <p class="text-gray-600 mb-4">${error}</p>
                    <button onclick="location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </button>
                </div>
            `;
        }

        // Update summary cards
        function updateSummaryCards(data) {
            document.getElementById('totalExpense').textContent = formatCurrency(data.totalExpense);
            document.getElementById('totalRecords').textContent = formatNumber(data.totalRecords);
            document.getElementById('allPRsCount').textContent = formatNumber(data.uniquePRCount || 0); // ‡πÉ‡∏ä‡πâ uniquePRCount ‡πÅ‡∏ó‡∏ô allPRs.length
            document.getElementById('activeMonths').textContent = formatNumber(data.monthlySummary.length);
        }

        // Create monthly expense chart
        function createMonthlyExpenseChart(monthlySummary) {
            const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlySummary.map(item => item.month.split(' ')[0]),
                    datasets: [{
                        label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: monthlySummary.map(item => item.totalExpense),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create distribution chart (month or status)
        function createDistributionChart(allPRs, monthlySummary, type = 'month') {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            let chartData, chartLabels, colors;
            
            if (type === 'month') {
                // ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡πÉ‡∏ä‡πâ unique PR count ‡∏à‡∏≤‡∏Å monthlySummary
                chartLabels = monthlySummary.map(month => month.month.split(' ')[0]); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                chartData = monthlySummary.map(month => month.uniquePRCount || 0); // ‡πÉ‡∏ä‡πâ uniquePRCount
                colors = [
                    '#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
                    '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16',
                    '#F97316', '#6366F1', '#14B8A6', '#F43F5E'
                ];
            } else {
                // ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ - ‡∏ô‡∏±‡∏ö unique PR ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                const statusPRs = {};
                allPRs.forEach(pr => {
                    const status = pr.status || 'UNKNOWN';
                    if (!statusPRs[status]) {
                        statusPRs[status] = new Set();
                    }
                    statusPRs[status].add(pr.prNo); // ‡πÉ‡∏ä‡πâ Set ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥
                });
                
                chartLabels = Object.keys(statusPRs);
                chartData = Object.values(statusPRs).map(prSet => prSet.size); // ‡∏ô‡∏±‡∏ö unique PR
                colors = [
                    '#10B981', '#EF4444', '#F59E0B', '#8B5CF6', 
                    '#06B6D4', '#EC4899', '#84CC16', '#F97316'
                ];
            }
            
            distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PR (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Populate all PRs table
        function populateAllPRsTable(allPRs) {
            const tableBody = document.getElementById('allPRsTable');
            
            if (allPRs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PR
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = allPRs.map(pr => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${pr.prNo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pr.date}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${pr.item}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pr.qty} ${pr.unit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${pr.amount > 20000 ? 'text-red-600' : 'text-blue-600'}">${formatCurrency(pr.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(pr.status)}">${pr.status}</span>
                    </td>
                </tr>
            `).join('');
        }

        // Populate monthly summary table
        function populateMonthlySummaryTable(monthlySummary) {
            const tableBody = document.getElementById('monthlySummaryTable');
            const totalExpense = monthlySummary.reduce((sum, month) => sum + month.totalExpense, 0);
            
            tableBody.innerHTML = monthlySummary.map(month => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${month.month}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${formatCurrency(month.totalExpense)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(month.recordCount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(month.maxExpense)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${month.percentage.toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        // Create insights
        function createInsights(data) {
            const insightsContainer = document.getElementById('insights');
            const maxExpenseMonth = data.monthlySummary.reduce((max, month) => 
                month.totalExpense > max.totalExpense ? month : max, data.monthlySummary[0]);
            
            const maxPR = data.allPRs.length > 0 ? 
                data.allPRs.reduce((max, pr) => pr.amount > max.amount ? pr : max) : null;
            
            const highValuePRs = data.allPRs.filter(pr => pr.amount > 20000);
            
            // ‡∏ô‡∏±‡∏ö unique PR ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ > 20K
            const uniqueHighValuePRs = new Set(highValuePRs.map(pr => pr.prNo));
            
            const avgExpensePerPR = data.uniquePRCount > 0 ? data.totalExpense / data.uniquePRCount : 0; // ‡πÉ‡∏ä‡πâ uniquePRCount
            
            insightsContainer.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">${maxExpenseMonth.percentage.toFixed(1)}%</div>
                    <div class="text-sm text-gray-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (${maxExpenseMonth.month.split(' ')[0]})</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600">${maxPR ? formatCurrency(maxPR.amount) : '0 ‡∏ø'}</div>
                    <div class="text-sm text-gray-600">PR ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">${uniqueHighValuePRs.size}</div>
                    <div class="text-sm text-gray-600">PR ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ > 20K (Unique)</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600">${formatCurrency(avgExpensePerPR)}</div>
                    <div class="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠ PR (Unique)</div>
                </div>
            `;
        }

        // Setup chart type selector
        function setupChartTypeSelector(allPRs, monthlySummary) {
            const chartTypeSelector = document.getElementById('chartTypeSelector');
            
            chartTypeSelector.addEventListener('change', function() {
                const selectedType = this.value;
                createDistributionChart(allPRs, monthlySummary, selectedType);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≤‡∏ü
                const chartTitle = this.closest('.bg-white').querySelector('h3');
                if (selectedType === 'month') {
                    chartTitle.textContent = 'üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ PR - ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
                } else {
                    chartTitle.textContent = 'üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ PR - ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
                }
            });
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const chartTitle = chartTypeSelector.closest('.bg-white').querySelector('h3');
            chartTitle.textContent = 'üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ PR - ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
        }

        // Enhanced element finder with retry mechanism
        function findElementWithRetry(elementId, maxRetries = 5, delay = 200) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                
                function tryFind() {
                    attempts++;
                    const element = document.getElementById(elementId);
                    
                    if (element) {
                        console.log(`‚úÖ ‡∏û‡∏ö element '${elementId}' ‡πÉ‡∏ô attempt ${attempts}`);
                        resolve(element);
                    } else if (attempts >= maxRetries) {
                        console.error(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö element '${elementId}' ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å ${maxRetries} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
                        reject(new Error(`Element '${elementId}' not found after ${maxRetries} attempts`));
                    } else {
                        console.warn(`‚è≥ ‡πÑ‡∏°‡πà‡∏û‡∏ö element '${elementId}' attempt ${attempts}/${maxRetries} - ‡∏£‡∏≠ ${delay}ms`);
                        setTimeout(tryFind, delay);
                    }
                }
                
                tryFind();
            });
        }

        // Setup status filter with retry mechanism
        async function setupStatusFilter(allPRs) {
            try {
                console.log('üè∑Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Status Filter...');
                
                // ‡πÉ‡∏ä‡πâ retry mechanism ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ statusFilter
                const statusFilter = await findElementWithRetry('statusFilter', 10, 100);
                
                // ‡∏•‡πâ‡∏≤‡∏á options ‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô "‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞")
                statusFilter.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>';
                
                const uniqueStatuses = [...new Set(allPRs.map(pr => pr.status))].filter(status => status).sort();
                console.log('üè∑Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏û‡∏ö:', uniqueStatuses);
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                uniqueStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                });
                
                // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö status filter
                statusFilter.addEventListener('change', function() {
                    applyFilters(allPRs);
                });
                
                console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Status Filter ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
            } catch (error) {
                console.error('‚ùå Error ‡πÉ‡∏ô setupStatusFilter:', error);
                
                // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
                setTimeout(() => {
                    const statusFilter = document.querySelector('#statusFilter');
                    if (statusFilter) {
                        console.log('‚úÖ ‡∏û‡∏ö statusFilter ‡∏î‡πâ‡∏ß‡∏¢ querySelector');
                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
                        setupStatusFilterFallback(statusFilter, allPRs);
                    } else {
                        console.error('‚ùå ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö statusFilter ‡πÅ‡∏°‡πâ‡πÉ‡∏ä‡πâ querySelector');
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
                        createStatusFilterElement(allPRs);
                    }
                }, 500);
            }
        }

        // Setup month filter with retry mechanism  
        async function setupMonthFilter(allPRs) {
            try {
                console.log('üìÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Month Filter...');
                
                // ‡πÉ‡∏ä‡πâ retry mechanism ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ monthFilter
                const monthFilter = await findElementWithRetry('monthFilter', 10, 100);
                
                // ‡∏•‡πâ‡∏≤‡∏á options ‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô")
                monthFilter.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>';
                
                const uniqueMonths = [...new Set(allPRs.map(pr => pr.month))].filter(month => month).sort();
                console.log('üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö:', uniqueMonths);
                
                uniqueMonths.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    monthFilter.appendChild(option);
                });
                
                // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö month filter
                monthFilter.addEventListener('change', function() {
                    applyFilters(allPRs);
                });
                
                console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Month Filter ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
            } catch (error) {
                console.error('‚ùå Error ‡πÉ‡∏ô setupMonthFilter:', error);
                
                // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
                setTimeout(() => {
                    const monthFilter = document.querySelector('#monthFilter');
                    if (monthFilter) {
                        console.log('‚úÖ ‡∏û‡∏ö monthFilter ‡∏î‡πâ‡∏ß‡∏¢ querySelector');
                        setupMonthFilterFallback(monthFilter, allPRs);
                    } else {
                        console.error('‚ùå ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö monthFilter ‡πÅ‡∏°‡πâ‡πÉ‡∏ä‡πâ querySelector');
                    }
                }, 500);
            }
        }

        // Fallback function for status filter
        function setupStatusFilterFallback(statusFilter, allPRs) {
            try {
                statusFilter.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>';
                
                const uniqueStatuses = [...new Set(allPRs.map(pr => pr.status))].filter(status => status).sort();
                
                uniqueStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                });
                
                statusFilter.addEventListener('change', function() {
                    applyFilters(allPRs);
                });
                
                console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Status Filter Fallback ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('‚ùå Error ‡πÉ‡∏ô setupStatusFilterFallback:', error);
            }
        }

        // Fallback function for month filter
        function setupMonthFilterFallback(monthFilter, allPRs) {
            try {
                monthFilter.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>';
                
                const uniqueMonths = [...new Set(allPRs.map(pr => pr.month))].filter(month => month).sort();
                
                uniqueMonths.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    monthFilter.appendChild(option);
                });
                
                monthFilter.addEventListener('change', function() {
                    applyFilters(allPRs);
                });
                
                console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Month Filter Fallback ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('‚ùå Error ‡πÉ‡∏ô setupMonthFilterFallback:', error);
            }
        }

        // Enhanced debugging function for filters
        function debugFilters() {
            console.log('üîç === DEBUG FILTERS ===');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á monthFilter ‡πÅ‡∏•‡∏∞ statusFilter
            const filters = ['monthFilter', 'statusFilter'];
            
            filters.forEach(filterId => {
                console.log(`\nüîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ${filterId}:`);
                
                // Method 1: getElementById
                const byId = document.getElementById(filterId);
                console.log(`  üìã getElementById: ${byId ? '‚úÖ ‡∏û‡∏ö' : '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, byId);
                
                // Method 2: querySelector
                const byQuery = document.querySelector(`#${filterId}`);
                console.log(`  üìã querySelector: ${byQuery ? '‚úÖ ‡∏û‡∏ö' : '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, byQuery);
                
                // Method 3: querySelectorAll
                const byQueryAll = document.querySelectorAll(`#${filterId}`);
                console.log(`  üìã querySelectorAll: ${byQueryAll.length} elements`, byQueryAll);
                
                // Method 4: search in all selects
                const allSelects = document.querySelectorAll('select');
                const selectInfo = [];
                allSelects.forEach((select, index) => {
                    selectInfo.push({
                        index,
                        id: select.id || 'no-id',
                        className: select.className,
                        parentElement: select.parentElement?.tagName
                    });
                });
                console.log(`  üìã ‡∏ó‡∏∏‡∏Å select elements:`, selectInfo);
                
                // ‡∏´‡∏≤ select ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ filter ‡πÉ‡∏ô class ‡∏´‡∏£‡∏∑‡∏≠ id
                const filterSelects = Array.from(allSelects).filter(select => 
                    (select.id && select.id.includes('filter')) || 
                    (select.className && select.className.includes('filter'))
                );
                console.log(`  üìã select elements ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö filter:`, filterSelects);
            });
            
            console.log('üîç === END DEBUG ===\n');
        }

        // Create missing filter elements if needed
        function createMissingFilters() {
            console.log('üîß ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Filter Elements...');
            
            // ‡∏´‡∏≤ container
            const container = document.querySelector('.flex.flex-wrap.gap-4.mb-6') || 
                            document.querySelector('.flex.space-x-4.mb-6');
            
            if (!container) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö filter container');
                return false;
            }
            
            console.log('‚úÖ ‡∏û‡∏ö filter container:', container);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á statusFilter ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ
            let statusFilter = document.getElementById('statusFilter');
            if (!statusFilter) {
                console.log('üîß ‡∏™‡∏£‡πâ‡∏≤‡∏á statusFilter ‡πÉ‡∏´‡∏°‡πà...');
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'flex-1 min-w-[200px]';
                statusDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="statusFilter" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                    </select>
                `;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô container
                const monthFilterDiv = container.querySelector('div');
                if (monthFilterDiv && monthFilterDiv.nextSibling) {
                    container.insertBefore(statusDiv, monthFilterDiv.nextSibling);
                } else {
                    container.appendChild(statusDiv);
                }
                
                statusFilter = document.getElementById('statusFilter');
                console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á statusFilter ‡πÄ‡∏™‡∏£‡πá‡∏à:', statusFilter);
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á monthFilter ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ
            let monthFilter = document.getElementById('monthFilter');
            if (!monthFilter) {
                console.log('üîß ‡∏™‡∏£‡πâ‡∏≤‡∏á monthFilter ‡πÉ‡∏´‡∏°‡πà...');
                
                const monthDiv = document.createElement('div');
                monthDiv.className = 'flex-1 min-w-[200px]';
                monthDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <select id="monthFilter" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    </select>
                `;
                
                container.insertBefore(monthDiv, container.firstChild);
                monthFilter = document.getElementById('monthFilter');
                console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á monthFilter ‡πÄ‡∏™‡∏£‡πá‡∏à:', monthFilter);
            }
            
            return { monthFilter, statusFilter };
        }

        // Apply filters (both month and status) with enhanced error handling
        async function applyFilters(allPRs) {
            try {
                console.log('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                // ‡πÉ‡∏ä‡πâ retry mechanism ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ filter elements
                let monthFilter, statusFilter;
                
                try {
                    monthFilter = await findElementWithRetry('monthFilter', 3, 100);
                } catch (error) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö monthFilter - ‡πÉ‡∏ä‡πâ querySelector');
                    monthFilter = document.querySelector('#monthFilter');
                }
                
                try {
                    statusFilter = await findElementWithRetry('statusFilter', 3, 100);
                } catch (error) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö statusFilter - ‡πÉ‡∏ä‡πâ querySelector');
                    statusFilter = document.querySelector('#statusFilter');
                }
                
                if (!monthFilter && !statusFilter) {
                    console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö filter elements ‡πÉ‡∏î‡πÄ‡∏•‡∏¢');
                    return;
                }
                
                const selectedMonth = monthFilter ? monthFilter.value : 'all';
                const selectedStatus = statusFilter ? statusFilter.value : 'all';
                
                let filteredPRs = allPRs;
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                if (selectedMonth !== 'all') {
                    filteredPRs = filteredPRs.filter(pr => pr.month === selectedMonth);
                }
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                if (selectedStatus !== 'all') {
                    filteredPRs = filteredPRs.filter(pr => pr.status === selectedStatus);
                }
                
                console.log(`üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${filteredPRs.length} ‡∏à‡∏≤‡∏Å ${allPRs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                console.log(`üìä ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô="${selectedMonth}", ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞="${selectedStatus}"`);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                populateAllPRsTable(filteredPRs);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                updateFilterResults(filteredPRs.length, allPRs.length);
                
            } catch (error) {
                console.error('‚ùå Error ‡πÉ‡∏ô applyFilters:', error);
                
                // Fallback: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏≤‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                console.log('üîÑ Fallback: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
                populateAllPRsTable(allPRs);
                updateFilterResults(allPRs.length, allPRs.length);
            }
        }

        // Update filter results display with error handling
        function updateFilterResults(filteredCount, totalCount) {
            try {
                const tableTitle = document.querySelector('.bg-white h3');
                if (!tableTitle) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö table title element');
                    return;
                }
                
                if (filteredCount === totalCount) {
                    tableTitle.textContent = 'üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                } else {
                    tableTitle.textContent = `üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏™‡∏î‡∏á ${filteredCount} ‡∏à‡∏≤‡∏Å ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
                }
            } catch (error) {
                console.error('‚ùå Error ‡πÉ‡∏ô updateFilterResults:', error);
            }
        }

        // Utility functions
        function formatNumber(num) {
            return num.toLocaleString('th-TH');
        }

        function formatCurrency(num) {
            return num.toLocaleString('th-TH') + ' ‡∏ø';
        }

        function getStatusClass(status) {
            switch (status.toUpperCase()) {
                case 'RECEIVED':
                    return 'status-received';
                case 'PENDING':
                    return 'status-pending';
                default:
                    return 'status-other';
            }
        }
    </script>
</body>
</html>
